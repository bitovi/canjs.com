<!DOCTYPE html>

<html>
<head>
  <title>model.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>model.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>steal(<span class="hljs-string">'can/util'</span>, <span class="hljs-string">'can/map'</span>, <span class="hljs-string">'can/list'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(can)</span> </span>{
	<span class="hljs-comment">/** @add can.Model **/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="model-js">model.js</h2>
<p>(Don’t steal this file directly in your code.)</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="pipe">pipe</h2>
<p><code>pipe</code> lets you pipe the results of a successful deferred
through a function before resolving the deferred.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> pipe = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(def, thisArg, func)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The piped result will be available through a new Deferred.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> d = <span class="hljs-keyword">new</span> can.Deferred();
		def.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">var</span> args = can.makeArray(<span class="hljs-built_in">arguments</span>),
				success = <span class="hljs-literal">true</span>;

			<span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Pipe the results through the function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				args[<span class="hljs-number">0</span>] = func.apply(thisArg, args);
			} <span class="hljs-keyword">catch</span> (e) {
				success = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The function threw an error, so reject the Deferred.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				d.rejectWith(d, [e].concat(args));
			}
			<span class="hljs-keyword">if</span> (success) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Resolve the new Deferred with the piped value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				d.resolveWith(d, args);
			}
		}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Pass on the rejection if the original Deferred never resolved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			d.rejectWith(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><code>can.ajax</code> returns a Deferred with an abort method to halt the AJAX call.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> def.abort === <span class="hljs-string">'function'</span>) {
			d.abort = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				<span class="hljs-keyword">return</span> def.abort();
			};
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Return the new (piped) Deferred.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> d;
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="modelnum">modelNum</h2>
<p>When new model constructors are set up without a full name,
<code>modelNum</code> lets us name them uniquely (to keep track of them).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		modelNum = <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="getid">getId</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getId = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(inst)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><code>can.__reading</code> makes a note that <code>id</code> was just read.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			can.__reading(inst, inst.constructor.id);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Use <code>__get</code> instead of <code>attr</code> for performance. (But that means we have to remember to call <code>can.__reading</code>.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">return</span> inst.__get(inst.constructor.id);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2 id="ajax">ajax</h2>
<p>This helper method makes it easier to make an AJAX call from the configuration of the Model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		ajax = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ajaxOb, data, type, dataType, success, error)</span> </span>{

			<span class="hljs-keyword">var</span> params = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>A string here would be something like <code>&quot;GET /endpoint&quot;</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> ajaxOb === <span class="hljs-string">'string'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Split on spaces to separate the HTTP method and the URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> parts = ajaxOb.split(<span class="hljs-regexp">/\s+/</span>);
				params.url = parts.pop();
				<span class="hljs-keyword">if</span> (parts.length) {
					params.type = parts.pop();
				}
			} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>If the first argument is an object, just load it into <code>params</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				can.extend(params, ajaxOb);
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If the <code>data</code> argument is a plain object, copy it into <code>params</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			params.data = <span class="hljs-keyword">typeof</span> data === <span class="hljs-string">"object"</span> &amp;&amp; !can.isArray(data) ?
				can.extend(params.data || {}, data) : data;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Substitute in data for any templated parts of the URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			params.url = can.sub(params.url, params.data, <span class="hljs-literal">true</span>);

			<span class="hljs-keyword">return</span> can.ajax(can.extend({
				type: type || <span class="hljs-string">'post'</span>,
				dataType: dataType || <span class="hljs-string">'json'</span>,
				success: success,
				error: error
			}, params));
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="makerequest">makeRequest</h2>
<p>This function abstracts making the actual AJAX request away from the Model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		makeRequest = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(modelObj, type, success, error, method)</span> </span>{
			<span class="hljs-keyword">var</span> args;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>If <code>modelObj</code> is an Array, it it means we are coming from
the queued request, and we’re passing already-serialized data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (can.isArray(modelObj)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>In that case, modelObj’s signature will be <code>[modelObj, serializedData]</code>, so we need to unpack it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				args = modelObj[<span class="hljs-number">1</span>];
				modelObj = modelObj[<span class="hljs-number">0</span>];
			} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>If we aren’t supplied with serialized data, we’ll make our own.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				args = modelObj.serialize();
			}
			args = [args];

			<span class="hljs-keyword">var</span> deferred,
				model = modelObj.constructor,
				jqXHR;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>When calling <code>update</code> and <code>destroy</code>, the current ID needs to be the first parameter in the AJAX call.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (type === <span class="hljs-string">'update'</span> || type === <span class="hljs-string">'destroy'</span>) {
				args.unshift(getId(modelObj));
			}
			jqXHR = model[type].apply(model, args);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Make sure that can.Model can react to the request before anything else does.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			deferred = pipe(jqXHR, modelObj, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><code>method</code> is here because <code>&quot;destroyed&quot; !== &quot;destroy&quot; + &quot;d&quot;</code>.
TODO: Do something smarter/more consistent here?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				modelObj[method || type + <span class="hljs-string">"d"</span>](data, jqXHR);
				<span class="hljs-keyword">return</span> modelObj;
			});</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Hook up <code>abort</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (jqXHR.abort) {
				deferred.abort = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
					jqXHR.abort();
				};
			}

			deferred.then(success, error);
			<span class="hljs-keyword">return</span> deferred;
		},

		converters = {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h2 id="models">models</h2>
<p>The default function for converting into a list of models. Needs to be stored separate
because we will reference it in models static <code>setup</code>, too.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			models: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instancesRawData, oldList, xhr)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Increment reqs counter so new instances will be added to the store.
(This is cleaned up at the end of the method.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				can.Model._reqs++;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>If there is no data, we can’t really do anything with it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (!instancesRawData) {
					<span class="hljs-keyword">return</span>;
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>If the “raw” data is already a List, it’s not raw.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (instancesRawData <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">this</span>.List) {
					<span class="hljs-keyword">return</span> instancesRawData;
				}

				<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p><code>tmp</code> will hold the models before we push them onto <code>modelList</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					tmp = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><code>ML</code> (see way below) is just <code>can.Model.List</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					ListClass = self.List || ML,
					modelList = oldList <span class="hljs-keyword">instanceof</span> can.List ? oldList : <span class="hljs-keyword">new</span> ListClass(),</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Check if we were handed an Array or a model list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					rawDataIsList = instancesRawData <span class="hljs-keyword">instanceof</span> ML,</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Get the “plain” objects from the models from the list/array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					raw = rawDataIsList ? instancesRawData.serialize() : instancesRawData;

				raw = self.parseModels(raw, xhr);

				<span class="hljs-keyword">if</span>(raw.data) {
					instancesRawData = raw;
					raw = raw.data;
				}

				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> raw === <span class="hljs-string">'undefined'</span>) {
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Could not get any raw data while converting using .models'</span>);
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>!steal-remove-start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (!raw.length) {
					can.dev.warn(<span class="hljs-string">"model.js models has no data."</span>);
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>!steal-remove-end</p>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>If there was anything left in the list we were given, get rid of it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (modelList.length) {
					modelList.splice(<span class="hljs-number">0</span>);
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>If we pushed these directly onto the list, it would cause a change event for each model.
So, we push them onto <code>tmp</code> first and then push everything at once, causing one atomic change event that contains all the models at once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				can.each(raw, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(rawPart)</span> </span>{
					tmp.push(self.model(rawPart, xhr));
				});
				modelList.push.apply(modelList, tmp);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>If there was other stuff on <code>instancesRawData</code>, let’s transfer that onto <code>modelList</code> too.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (!can.isArray(instancesRawData)) {
					can.each(instancesRawData, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val, prop)</span> </span>{
						<span class="hljs-keyword">if</span> (prop !== <span class="hljs-string">'data'</span>) {
							modelList.attr(prop, val);
						}
					});
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Clean up the store on the next turn of the event loop. (<code>this</code> is a model constructor.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				setTimeout(can.proxy(<span class="hljs-keyword">this</span>._clean, <span class="hljs-keyword">this</span>), <span class="hljs-number">1</span>);
				<span class="hljs-keyword">return</span> modelList;
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h2 id="model">model</h2>
<p>A function that, when handed a plain object, turns it into a model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			model: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attributes, oldModel, xhr)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>If there’re no properties, there can be no model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (!attributes) {
					<span class="hljs-keyword">return</span>;
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>If this object knows how to serialize, parse, or access itself, we’ll use that instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> attributes.serialize === <span class="hljs-string">'function'</span>) {
					attributes = attributes.serialize();
				} <span class="hljs-keyword">else</span> {
					attributes = <span class="hljs-keyword">this</span>.parseModel(attributes, xhr);
				}

				<span class="hljs-keyword">var</span> id = attributes[<span class="hljs-keyword">this</span>.id];</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Models from the store always have priority
0 is a valid ID.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span>((id || id === <span class="hljs-number">0</span>) &amp;&amp; <span class="hljs-keyword">this</span>.store[id]) {
					oldModel = <span class="hljs-keyword">this</span>.store[id];
				}

				<span class="hljs-keyword">var</span> model = oldModel &amp;&amp; can.isFunction(oldModel.attr) ?</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>If this model is in the store already, just update it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						oldModel.attr(attributes, <span class="hljs-keyword">this</span>.removeAttr || <span class="hljs-literal">false</span>) :</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Otherwise, we need a new model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>(attributes);

				<span class="hljs-keyword">return</span> model;
			}
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <h2 id="makeparser">makeParser</h2>
<p>This object describes how to take the data from an AJAX request and prepare it for <code>models</code> and <code>model</code>.
These functions are meant to be overwritten (if necessary) in an extended model constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		makeParser = {
			parseModel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(prop)</span> </span>{
				<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attributes)</span> </span>{
					<span class="hljs-keyword">return</span> prop ? can.getObject(prop, attributes) : attributes;
				};
			},
			parseModels: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(prop)</span> </span>{
				<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attributes)</span> </span>{
					<span class="hljs-keyword">if</span>(can.isArray(attributes)) {
						<span class="hljs-keyword">return</span> attributes;
					}

					prop = prop || <span class="hljs-string">'data'</span>;

					<span class="hljs-keyword">var</span> result = can.getObject(prop, attributes);
					<span class="hljs-keyword">if</span>(!can.isArray(result)) {
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Could not get any raw data while converting using .models'</span>);
					}
					<span class="hljs-keyword">return</span> result;
				};
			}
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h2 id="ajaxmethods">ajaxMethods</h2>
<p>This object describes how to make an AJAX request for each ajax method (<code>create</code>, <code>update</code>, etc.)
Each AJAX method is an object in <code>ajaxMethods</code> and can have the following properties:</p>
<ul>
<li><code>url</code>: Which property on the model contains the default URL for this method.</li>
<li><code>type</code>: The default HTTP request method.</li>
<li><code>data</code>: A method that takes the arguments from <code>makeRequest</code> (see above) and returns a data object for use in the AJAX call.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>		ajaxMethods = {
			create: {
				url: <span class="hljs-string">"_shortName"</span>,
				type: <span class="hljs-string">"post"</span>
			},
			update: {</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <h2 id="update-data">update.data</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>				data: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id, attrs)</span> </span>{
					attrs = attrs || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p><code>this.id</code> is the property that represents the ID (and is usually <code>&quot;id&quot;</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">var</span> identity = <span class="hljs-keyword">this</span>.id;</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>If the value of the property being used as the ID changed,
indicate that in the request and replace the current ID property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (attrs[identity] &amp;&amp; attrs[identity] !== id) {
						attrs[<span class="hljs-string">"new"</span> + can.capitalize(id)] = attrs[identity];
						<span class="hljs-keyword">delete</span> attrs[identity];
					}
					attrs[identity] = id;

					<span class="hljs-keyword">return</span> attrs;
				},
				type: <span class="hljs-string">"put"</span>
			},
			destroy: {
				type: <span class="hljs-string">'delete'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <h2 id="destroy-data">destroy.data</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>				data: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id, attrs)</span> </span>{
					attrs = attrs || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p><code>this.id</code> is the property that represents the ID (and is usually <code>&quot;id&quot;</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					attrs.id = attrs[<span class="hljs-keyword">this</span>.id] = id;
					<span class="hljs-keyword">return</span> attrs;
				}
			},
			findAll: {
				url: <span class="hljs-string">"_shortName"</span>
			},
			findOne: {}
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <h2 id="ajaxmaker">ajaxMaker</h2>
<p>Takes a method defined just above and a string that describes how to call that method
and makes a function that calls that method with the given data.</p>
<ul>
<li><code>ajaxMethod</code>: The object defined above in <code>ajaxMethods</code>.</li>
<li><code>str</code>: The string the configuration provided (such as <code>&quot;/recipes.json&quot;</code> for a <code>findAll</code> call).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>		ajaxMaker = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ajaxMethod, str)</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
				data = ajaxMethod.data ?</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>If the AJAX method mentioned above has its own way of getting <code>data</code>, use that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					ajaxMethod.data.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>) :</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Otherwise, just use the data passed in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					data;</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Make the AJAX call with the URL, data, and type indicated by the proper <code>ajaxMethod</code> above.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">return</span> ajax(str || <span class="hljs-keyword">this</span>[ajaxMethod.url || <span class="hljs-string">"_url"</span>], data, ajaxMethod.type || <span class="hljs-string">"get"</span>);
			};
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <h2 id="createurlfromresource">createURLFromResource</h2>
<p>For each of the names (create, update, destroy, findOne, and findAll) use the 
URL provided by the <code>resource</code> property. For example:</p>
<pre><code>    ToDo = can.Model.extend({
        resource: <span class="hljs-string">"/todos"</span>
    }, {});

Will create a can.Model that is identical to:

    ToDo = can.Model.extend({
        findAll: <span class="hljs-string">"GET /todos"</span>,
        findOne: <span class="hljs-string">"GET /todos/{id}"</span>,
        create:  <span class="hljs-string">"POST /todos"</span>,
        update:  <span class="hljs-string">"PUT /todos/{id}"</span>,
        destroy: <span class="hljs-string">"DELETE /todos/{id}"</span>
    },{});
</code></pre><ul>
<li><code>model</code>: the can.Model that has the resource property</li>
<li><code>method</code>: a property from the ajaxMethod object</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>		createURLFromResource = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, name)</span> </span>{
			<span class="hljs-keyword">if</span> (!model.resource) { <span class="hljs-keyword">return</span>; }

			<span class="hljs-keyword">var</span> resource = model.resource.replace(<span class="hljs-regexp">/\/+$/</span>, <span class="hljs-string">""</span>);
			<span class="hljs-keyword">if</span> (name === <span class="hljs-string">"findAll"</span> || name === <span class="hljs-string">"create"</span>) {
				<span class="hljs-keyword">return</span> resource;
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">return</span> resource + <span class="hljs-string">"/{"</span> + model.id + <span class="hljs-string">"}"</span>;
			}
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <h1 id="can-model">can.Model</h1>
<p>A can.Map that connects to a RESTful interface.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-comment">/** @static */</span>
	can.Model = can.Map.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p><code>fullName</code> identifies the model type in debugging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			fullName: <span class="hljs-string">"can.Model"</span>,
			_reqs: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <h2 id="can-model-setup">can.Model.setup</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>			setup: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(base, fullName, staticProps, protoProps)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Assume <code>fullName</code> wasn’t passed. (<code>can.Model.extend({ ... }, { ... })</code>)
This is pretty usual.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fullName !== <span class="hljs-string">"string"</span>) {
					protoProps = staticProps;
					staticProps = fullName;
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Assume no static properties were passed. (<code>can.Model.extend({ ... })</code>)
This is really unusual for a model though, since there’s so much configuration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (!protoProps) {</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>!steal-remove-start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					can.dev.warn(<span class="hljs-string">"can/model/model.js: can.Model extended without static properties."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>!steal-remove-end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					protoProps = staticProps;
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Create the model store here, in case someone wants to use can.Model without inheriting from it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">this</span>.store = {};

				can.Map.setup.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
				<span class="hljs-keyword">if</span> (!can.Model) {
					<span class="hljs-keyword">return</span>;
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p><code>List</code> is just a regular can.Model.List that knows what kind of Model it’s hooked up to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span>(staticProps &amp;&amp; staticProps.List) {
					<span class="hljs-keyword">this</span>.List = staticProps.List;
					<span class="hljs-keyword">this</span>.List.Map = <span class="hljs-keyword">this</span>;
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">this</span>.List = base.List.extend({
						Map: <span class="hljs-keyword">this</span>
					}, {});
				}

				<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
					clean = can.proxy(<span class="hljs-keyword">this</span>._clean, self);</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Go through <code>ajaxMethods</code> and set up static methods according to their configurations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				can.each(ajaxMethods, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(method, name)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Check the configuration for this ajaxMethod.
If the configuration isn’t a function, it should be a string (like <code>&quot;GET /endpoint&quot;</code>)
or an object like <code>{url: &quot;/endpoint&quot;, type: &#39;GET&#39;}</code>.</p>

            </div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>if we have a string(like <code>&quot;GET /endpoint&quot;</code>) or an object(ajaxSettings) set in the static definition(not inherited),
convert it to a function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>(staticProps &amp;&amp; staticProps[name] &amp;&amp; (<span class="hljs-keyword">typeof</span> staticProps[name] === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> staticProps[name] === <span class="hljs-string">'object'</span>)) {
						self[name] = ajaxMaker(method, staticProps[name]);
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>if we have a resource property set in the static definition, but check if function exists already</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(staticProps &amp;&amp; staticProps.resource &amp;&amp; !can.isFunction(staticProps[name])) {
						self[name] = ajaxMaker(method, createURLFromResource(self, name));
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>There may also be a “maker” function (like <code>makeFindAll</code>) that alters the behavior of acting upon models
by changing when and how the function we just made with <code>ajaxMaker</code> gets called.
For example, you might cache responses and only make a call when you don’t have a cached response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (self[<span class="hljs-string">"make"</span> + can.capitalize(name)]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Use the “maker” function to make the new “ajaxMethod” function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">var</span> newMethod = self[<span class="hljs-string">"make"</span> + can.capitalize(name)](self[name]);</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Replace the “ajaxMethod” function in the configuration with the new one.
(<code>_overwrite</code> just overwrites a property in a given Construct.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						can.Construct._overwrite(self, base, name, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Increment the numer of requests…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							can.Model._reqs++;</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>…make the AJAX call (and whatever else you’re doing)…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							<span class="hljs-keyword">var</span> def = newMethod.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>…and clean up the store.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							<span class="hljs-keyword">var</span> then = def.then(clean, clean);</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Pass along <code>abort</code> so you can still abort the AJAX call.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							then.abort = def.abort;

							<span class="hljs-keyword">return</span> then;
						});
					}
				});

				<span class="hljs-keyword">var</span> hasCustomConverter = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Set up <code>models</code> and <code>model</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				can.each(converters, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(converter, name)</span> </span>{
					<span class="hljs-keyword">var</span> parseName = <span class="hljs-string">"parse"</span> + can.capitalize(name),
						dataProperty = (staticProps &amp;&amp; staticProps[name]) || self[name];</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>For legacy e.g. models: ‘someProperty’ we set the <code>parseModel(s)</code> property
to the given string and set .model(s) to the original converter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> dataProperty === <span class="hljs-string">'string'</span>) {
						self[parseName] = dataProperty;
						can.Construct._overwrite(self, base, name, converter);
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((staticProps &amp;&amp; staticProps[name])) {
						hasCustomConverter[parseName] = <span class="hljs-literal">true</span>;
					}
				});</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Sets up parseModel(s)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				can.each(makeParser, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(maker, parseName)</span> </span>{
					<span class="hljs-keyword">var</span> prop = (staticProps &amp;&amp; staticProps[parseName]) || self[parseName];</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>e.g. parseModels: ‘someProperty’ make a default parseModel(s)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> prop === <span class="hljs-string">'string'</span>) {
						can.Construct._overwrite(self, base, parseName, maker(prop));
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( (!staticProps || !can.isFunction(staticProps[parseName])) &amp;&amp; !self[parseName] ) {
						<span class="hljs-keyword">var</span> madeParser = maker();
						madeParser.useModelConverter = hasCustomConverter[parseName];</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Add a default parseModel(s) if there is none</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						can.Construct._overwrite(self, base, parseName, madeParser);
					}
				});</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Make sure we have a unique name for this Model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (self.fullName === <span class="hljs-string">"can.Model"</span> || !self.fullName) {
					self.fullName = <span class="hljs-string">"Model"</span> + (++modelNum);
				}

				can.Model._reqs = <span class="hljs-number">0</span>;
				<span class="hljs-keyword">this</span>._url = <span class="hljs-keyword">this</span>._shortName + <span class="hljs-string">"/{"</span> + <span class="hljs-keyword">this</span>.id + <span class="hljs-string">"}"</span>;
			},
			_ajax: ajaxMaker,
			_makeRequest: makeRequest,</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <h2 id="can-model-_clean">can.Model._clean</h2>
<p><code>_clean</code> cleans up the model store after a request happens.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_clean: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				can.Model._reqs--;</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Don’t clean up unless we have no pending requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (!can.Model._reqs) {
					<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> id <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.store) {</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Delete all items in the store without any event bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.store[id]._bindings) {
							<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.store[id];
						}
					}
				}
				<span class="hljs-keyword">return</span> <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>];
			},
			models: converters.models,
			model: converters.model
		},
		<span class="hljs-comment">/** @prototype */</span>
		{</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <h2 id="can-model-setup">can.Model#setup</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>			setup: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attrs)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Try to add things as early as possible to the store (#457).
This is the earliest possible moment, even before any properties are set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> id = attrs &amp;&amp; attrs[<span class="hljs-keyword">this</span>.constructor.id];
				<span class="hljs-keyword">if</span> (can.Model._reqs &amp;&amp; id != <span class="hljs-literal">null</span>) {
					<span class="hljs-keyword">this</span>.constructor.store[id] = <span class="hljs-keyword">this</span>;
				}
				can.Map.prototype.setup.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <h2 id="can-model-isnew">can.Model#isNew</h2>
<p>Something is new if its ID is <code>null</code> or <code>undefined</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			isNew: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				<span class="hljs-keyword">var</span> id = getId(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>0 is a valid ID.
TODO: Why not <code>return id === null || id === undefined;</code>?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">return</span> !(id || id === <span class="hljs-number">0</span>); <span class="hljs-comment">// If `null` or `undefined`</span>
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <h2 id="can-model-save">can.Model#save</h2>
<p><code>save</code> calls <code>create</code> or <code>update</code> as necessary, based on whether a model is new.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			save: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(success, error)</span> </span>{
				<span class="hljs-keyword">return</span> makeRequest(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.isNew() ? <span class="hljs-string">'create'</span> : <span class="hljs-string">'update'</span>, success, error);
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <h2 id="can-model-destroy">can.Model#destroy</h2>
<p>Acts like can.Map.destroy but it also makes an AJAX call.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			destroy: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(success, error)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>If this model is new, don’t make an AJAX call.
Instead, we have to construct the Deferred ourselves and return it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isNew()) {
					<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
					<span class="hljs-keyword">var</span> def = can.Deferred();
					def.then(success, error);

					<span class="hljs-keyword">return</span> def.done(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
						self.destroyed(data);
					}).resolve(self);
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>If it isn’t new, though, go ahead and make a request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">return</span> makeRequest(<span class="hljs-keyword">this</span>, <span class="hljs-string">'destroy'</span>, success, error, <span class="hljs-string">'destroyed'</span>);
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <h2 id="can-model-bind-and-can-model-unbind">can.Model#bind and can.Model#unbind</h2>
<p>These aren’t actually implemented here, but their setup needs to be changed to account for the store.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_bindsetup: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				<span class="hljs-keyword">var</span> modelInstance = <span class="hljs-keyword">this</span>.__get(<span class="hljs-keyword">this</span>.constructor.id);
				<span class="hljs-keyword">if</span> (modelInstance != <span class="hljs-literal">null</span>) {
					<span class="hljs-keyword">this</span>.constructor.store[modelInstance ] = <span class="hljs-keyword">this</span>;
				}
				<span class="hljs-keyword">return</span> can.Map.prototype._bindsetup.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
			},
			_bindteardown: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.constructor.store[getId(<span class="hljs-keyword">this</span>)];
				<span class="hljs-keyword">return</span> can.Map.prototype._bindteardown.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Change the behavior of <code>___set</code> to account for the store.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			___set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(prop, val)</span> </span>{
				can.Map.prototype.___set.call(<span class="hljs-keyword">this</span>, prop, val);</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>If we add or change the ID, update the store accordingly.
TODO: shouldn’t this also delete the record from the old ID in the store?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (prop === <span class="hljs-keyword">this</span>.constructor.id &amp;&amp; <span class="hljs-keyword">this</span>._bindings) {
					<span class="hljs-keyword">this</span>.constructor.store[getId(<span class="hljs-keyword">this</span>)] = <span class="hljs-keyword">this</span>;
				}
			}
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Returns a function that knows how to prepare data from <code>findAll</code> or <code>findOne</code> calls.
<code>name</code> should be either <code>model</code> or <code>models</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> makeGetterHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, readyState, xhr)</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[name](data, <span class="hljs-literal">null</span>, xhr);
		};
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Handle data returned from <code>create</code>, <code>update</code>, and <code>destroy</code> calls.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	createUpdateDestroyHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
		<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.parseModel.useModelConverter) {
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.model(data);
		}

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.parseModel(data);
	};

	<span class="hljs-keyword">var</span> responseHandlers = {
		makeFindAll: makeGetterHandler(<span class="hljs-string">"models"</span>),
		makeFindOne: makeGetterHandler(<span class="hljs-string">"model"</span>),
		makeCreate: createUpdateDestroyHandler,
		makeUpdate: createUpdateDestroyHandler,
		makeDestroy: createUpdateDestroyHandler
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Go through the response handlers and make the actual “make” methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	can.each(responseHandlers, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(method, name)</span> </span>{
		can.Model[name] = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(oldMethod)</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				<span class="hljs-keyword">var</span> args = can.makeArray(<span class="hljs-built_in">arguments</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>If args[1] is a function, we were only passed one argument before success and failure callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					oldArgs = can.isFunction(args[<span class="hljs-number">1</span>]) ? args.splice(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) : args.splice(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Call the AJAX method (<code>findAll</code> or <code>update</code>, etc.) and pipe it through the response handler from above.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					def = pipe(oldMethod.apply(<span class="hljs-keyword">this</span>, oldArgs), <span class="hljs-keyword">this</span>, method);

				def.then(args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>]);
				<span class="hljs-keyword">return</span> def;
			};
		};
	});</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <h2 id="can-model-created-can-model-updated-and-can-model-destroyed">can.Model.created, can.Model.updated, and can.Model.destroyed</h2>
<p>Livecycle methods for models.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	can.each([
		<span class="hljs-string">"created"</span>,
		<span class="hljs-string">"updated"</span>,
		<span class="hljs-string">"destroyed"</span>
	], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(funcName)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Each of these is pretty much the same, except for the events they trigger.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		can.Model.prototype[funcName] = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attrs)</span> </span>{
			<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
				constructor = self.constructor;</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Update attributes if attributes have been passed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span>(attrs &amp;&amp; <span class="hljs-keyword">typeof</span> attrs === <span class="hljs-string">'object'</span>) {
				<span class="hljs-keyword">this</span>.attr(can.isFunction(attrs.attr) ? attrs.attr() : attrs);
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>triggers change event that bubble’s like
handler( ‘change’,’1.destroyed’ ). This is used
to remove items on destroyed from Model Lists.
but there should be a better way.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			can.dispatch.call(<span class="hljs-keyword">this</span>, {type:<span class="hljs-string">"change"</span>, target: <span class="hljs-keyword">this</span>}, [funcName]);</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>!steal-remove-start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			can.dev.log(<span class="hljs-string">"Model.js - "</span> + constructor.shortName + <span class="hljs-string">" "</span> + funcName);</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>!steal-remove-end</p>

            </div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Call event on the instance’s Class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			can.dispatch.call(constructor, funcName, [<span class="hljs-keyword">this</span>]);
		};
	});</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <h1 id="can-model-list">can.Model.List</h1>
<p>Model Lists are just like <code>Map.List</code>s except that when their items are
destroyed, they automatically get removed from the List.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> ML = can.Model.List = can.List.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <h2 id="can-model-list-setup">can.Model.List.setup</h2>
<p>On change or a nested named event, setup change bubbling.
On any other type of event, setup “destroyed” bubbling.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		_bubbleRule: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName, list)</span> </span>{
			<span class="hljs-keyword">var</span> bubbleRules = can.List._bubbleRule(eventName, list);
			bubbleRules.push(<span class="hljs-string">'destroyed'</span>);
			<span class="hljs-keyword">return</span> bubbleRules;
		}
	},{
		setup: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(params)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>If there was a plain object passed to the List constructor,
we use those as parameters for an initial findAll.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (can.isPlainObject(params) &amp;&amp; !can.isArray(params)) {
				can.List.prototype.setup.apply(<span class="hljs-keyword">this</span>);
				<span class="hljs-keyword">this</span>.replace(can.isDeferred(params) ? params : <span class="hljs-keyword">this</span>.constructor.Map.findAll(params));
			} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Otherwise, set up the list like normal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				can.List.prototype.setup.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
			}
			<span class="hljs-keyword">this</span>._init = <span class="hljs-number">1</span>;
			<span class="hljs-keyword">this</span>.bind(<span class="hljs-string">'destroyed'</span>, can.proxy(<span class="hljs-keyword">this</span>._destroyed, <span class="hljs-keyword">this</span>));
			<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._init;
		},
		_destroyed: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ev, attr)</span> </span>{
			<span class="hljs-keyword">if</span> (<span class="hljs-regexp">/\w+/</span>.test(attr)) {
				<span class="hljs-keyword">var</span> index;
				<span class="hljs-keyword">while</span>((index = <span class="hljs-keyword">this</span>.indexOf(ev.target)) &gt; -<span class="hljs-number">1</span>) {
					<span class="hljs-keyword">this</span>.splice(index, <span class="hljs-number">1</span>);
				}
			}
		}
	});

	<span class="hljs-keyword">return</span> can.Model;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
