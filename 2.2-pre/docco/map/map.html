<!DOCTYPE html>

<html>
<head>
  <title>can/map/map.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="bubble.html">
                bubble.js
              </a>
            
              
              <a class="source" href="map.html">
                map.js
              </a>
            
              
              <a class="source" href="map_benchmark.html">
                map_benchmark.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="can-map-map-js">can/map/map.js</h1>
<p><code>can.Map</code> provides the observable pattern for JavaScript Objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>





steal(<span class="hljs-string">'can/util'</span>, <span class="hljs-string">'can/util/bind'</span>,<span class="hljs-string">'./bubble.js'</span>, <span class="hljs-string">'can/construct'</span>, <span class="hljs-string">'can/util/batch'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(can, bind, bubble)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="helpers">Helpers</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>A temporary map of Maps that have been made from plain JS objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> madeMap = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Clears out map of converted objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> teardownMap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> cid <span class="hljs-keyword">in</span> madeMap) {
			<span class="hljs-keyword">if</span> (madeMap[cid].added) {
				<span class="hljs-keyword">delete</span> madeMap[cid].obj._cid;
			}
		}
		madeMap = <span class="hljs-literal">null</span>;
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Retrieves a Map instance from an Object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> getMapFromObject = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> </span>{
		<span class="hljs-keyword">return</span> madeMap &amp;&amp; madeMap[obj._cid] &amp;&amp; madeMap[obj._cid].instance;
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>A temporary map of Maps</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> serializeMap = <span class="hljs-literal">null</span>;


	<span class="hljs-comment">/**
	 * @add can.Map
	 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> Map = can.Map = can.Construct.extend({
			<span class="hljs-comment">/**
			 * @static
			 */</span>
			setup: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

				can.Construct.setup.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Do not run if we are defining can.Map.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (can.Map) {
					<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.defaults) {
						<span class="hljs-keyword">this</span>.defaults = {};
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Builds a list of compute and non-compute properties in this Object’s prototype.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">this</span>._computes = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>!steal-remove-start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.prototype.define &amp;&amp; !<span class="hljs-keyword">this</span>.helpers.define) {
						can.dev.warn(<span class="hljs-string">"can/map/define is not included, yet there is a define property "</span>+
							<span class="hljs-string">"used. You may want to add this plugin."</span>);
					}
					<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.define &amp;&amp; !<span class="hljs-keyword">this</span>.helpers.define) {
						can.dev.warn(<span class="hljs-string">"The define property should be on the map's prototype properties, "</span>+
							<span class="hljs-string">"not the static properies. Also, can/map/define is not included."</span>);
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>!steal-remove-end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.prototype) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Non-functions are regular defaults.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span> (
							prop !== <span class="hljs-string">"define"</span> &amp;&amp;
							prop !== <span class="hljs-string">"constructor"</span> &amp;&amp;
							(
								<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.prototype[prop] !== <span class="hljs-string">"function"</span> ||
								<span class="hljs-keyword">this</span>.prototype[prop].prototype <span class="hljs-keyword">instanceof</span> can.Construct
							)
						) {
							<span class="hljs-keyword">this</span>.defaults[prop] = <span class="hljs-keyword">this</span>.prototype[prop];</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Functions with an <code>isComputed</code> property are computes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.prototype[prop].isComputed) {
							<span class="hljs-keyword">this</span>._computes.push(prop);
						}
					}
					<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.helpers.define) {
						<span class="hljs-keyword">this</span>.helpers.define(<span class="hljs-keyword">this</span>);
					}
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>If we inherit from can.Map, but not can.List, make sure any lists are the correct type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (can.List &amp;&amp; !(<span class="hljs-keyword">this</span>.prototype <span class="hljs-keyword">instanceof</span> can.List)) {
					<span class="hljs-keyword">this</span>.List = Map.List.extend({
						Map: <span class="hljs-keyword">this</span>
					}, {});
				}

			},</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Reference to bubbling helpers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_bubble: bubble,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Given an eventName, determine if bubbling should be setup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_bubbleRule: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
				<span class="hljs-keyword">return</span> (eventName === <span class="hljs-string">"change"</span> || eventName.indexOf(<span class="hljs-string">"."</span>) &gt;= <span class="hljs-number">0</span> ) &amp;&amp; <span class="hljs-string">"change"</span>;
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>List of computes on the Map’s prototype.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_computes: [],</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Adds an event to this Map.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			bind: can.bindAndSetup,
			on: can.bindAndSetup,</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Removes an event from this Map.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			unbind: can.unbindAndTeardown,
			off: can.unbindAndTeardown,</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Name of the id field. Used in can.Model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			id: <span class="hljs-string">"id"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="internal-helpers">Internal helpers</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>			helpers: {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h3 id="can-map-helpers-define">can.Map.helpers.define</h3>
<p>Stub function for the define plugin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				define: <span class="hljs-literal">null</span>,
				<span class="hljs-comment">/**
				 * @hide
				 * Parses attribute name into its parts
				 * @param {String|Array} attr attribute name
				 * @param {Boolean} keepKey whether to keep the key intact
				 * @return {Array} attribute parts
				 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h3 id="can-map-helpers-attrparts">can.Map.helpers.attrParts</h3>
<p>Parses attribute name into its parts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				attrParts: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attr, keepKey)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Keep key intact</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
					<span class="hljs-keyword">if</span> (keepKey ) {
						<span class="hljs-keyword">return</span> [attr];
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Split key on ‘.’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> attr === <span class="hljs-string">"object"</span> ? attr : (<span class="hljs-string">""</span> + attr)
						.split(<span class="hljs-string">"."</span>);
				},
				<span class="hljs-comment">/**
				 * @hide
				 * Tracks Map instances created from JS Objects
				 * @param {Object} obj original Object
				 * @param {can.Map} instance the can.Map instance
				 * @return {Function} function to clear out object mapping
				 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h3 id="can-map-helpers-addtomap">can.Map.helpers.addToMap</h3>
<p>Tracks Map instances created from JS Objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				addToMap: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, instance)</span> </span>{
					<span class="hljs-keyword">var</span> teardown;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Setup a fresh mapping if <code>madeMap</code> is missing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (!madeMap) {
						teardown = teardownMap;
						madeMap = {};
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Record if Object has a <code>_cid</code> before adding one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">var</span> hasCid = obj._cid;
					<span class="hljs-keyword">var</span> cid = can.cid(obj);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Only update if there already isn’t one already.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (!madeMap[cid]) {

						madeMap[cid] = {
							obj: obj,
							instance: instance,
							added: !hasCid
						};
					}
					<span class="hljs-keyword">return</span> teardown;
				},
				<span class="hljs-comment">/**
				 * @hide
				 * Determines if `obj` is observable
				 * @param {Object} obj Object to check
				 * @return {Boolean} whether `obj` is an observable
				 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h3 id="can-map-helpers-isobservable">can.Map.helpers.isObservable</h3>
<p>Determines if <code>obj</code> is observable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				isObservable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span></span>{
					<span class="hljs-keyword">return</span> obj <span class="hljs-keyword">instanceof</span> can.Map || (obj &amp;&amp; obj === can.route);
				},
				<span class="hljs-comment">/**
				 * @hide
				 * Determines if `obj` can be made into an observable
				 * @param {Object} obj Object to check
				 * @return {Boolean} whether `obj` can be made into an observable
				 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h3 id="can-map-helpers-canmakeobserve">can.Map.helpers.canMakeObserve</h3>
<p>Determines if an object can be made into an observable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				canMakeObserve: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> </span>{
					<span class="hljs-keyword">return</span> obj &amp;&amp; !can.isDeferred(obj) &amp;&amp; (can.isArray(obj) || can.isPlainObject(obj) );
				},
				<span class="hljs-comment">/**
				 * @hide
				 * Serializes a Map or Map.List
				 * @param {can.Map|can.List} map The observable.
				 * @param {String} how To serialize using `attr` or `serialize`.
				 * @param {String} where Object or Array to put properties in.
				 * @return {Object|Array} serialized Map or List data.
				 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h3 id="can-map-helpers-serialize">can.Map.helpers.serialize</h3>
<p>Serializes a Map or Map.List</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				serialize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(map, how, where)</span> </span>{
					<span class="hljs-keyword">var</span> cid = can.cid(map),
						firstSerialize = <span class="hljs-literal">false</span>;
					<span class="hljs-keyword">if</span>(!serializeMap) {
						firstSerialize = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Serialize might call .attr() so we need to keep different map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						serializeMap = {
							attr: {},
							serialize: {}
						};
					}
					serializeMap[how][cid] = where;</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Go through each property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					map.each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val, name)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>If the value is an <code>object</code>, and has an <code>attrs</code> or <code>serialize</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">var</span> result,
							isObservable =  Map.helpers.isObservable(val),
							serialized = isObservable &amp;&amp; serializeMap[how][can.cid(val)];
						<span class="hljs-keyword">if</span>( serialized ) {
							result = serialized;
						} <span class="hljs-keyword">else</span> {
							<span class="hljs-keyword">if</span>(how === <span class="hljs-string">"serialize"</span>) {
								result = Map.helpers._serialize(map, name, val);
							} <span class="hljs-keyword">else</span> {
								result = Map.helpers._getValue(map, name, val, how);
							}
						}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>this is probably removable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span>(result !== <span class="hljs-literal">undefined</span>){
							where[name] = result;
						}
					});

					can.__reading(map, <span class="hljs-string">'__keys'</span>);
					<span class="hljs-keyword">if</span>(firstSerialize) {
						serializeMap = <span class="hljs-literal">null</span>;
					}
					<span class="hljs-keyword">return</span> where;
				},
				_serialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(map, name, val)</span></span>{
					<span class="hljs-keyword">return</span> Map.helpers._getValue(map, name, val, <span class="hljs-string">"serialize"</span>);
				},
				_getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(map, name, val, how)</span></span>{
					<span class="hljs-keyword">if</span>( Map.helpers.isObservable(val) ) {
						<span class="hljs-keyword">return</span> val[how]();
					} <span class="hljs-keyword">else</span> {
						<span class="hljs-keyword">return</span> val;
					}
				}
			},
			<span class="hljs-comment">/**
			 * @hide
			 * Returns list of keys in a Map
			 * @param {can.Map} map
			 * @returns {Array}
			 */</span>
			keys: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(map)</span> </span>{
				<span class="hljs-keyword">var</span> keys = [];
				can.__reading(map, <span class="hljs-string">'__keys'</span>);
				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> keyName <span class="hljs-keyword">in</span> map._data) {
					keys.push(keyName);
				}
				<span class="hljs-keyword">return</span> keys;
			}
		},
		<span class="hljs-comment">/**
		 * @prototype
		 */</span>
		{
			setup: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> </span>{
				<span class="hljs-keyword">if</span>(obj <span class="hljs-keyword">instanceof</span> can.Map){
					obj = obj.serialize();
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p><code>_data</code> is where we keep the properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">this</span>._data = {};
				<span class="hljs-comment">/**
				 * @property {String} can.Map.prototype._cid
				 * @hide
				 *
				 * A globally unique ID for this `can.Map` instance.
				 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>The namespace this <code>object</code> uses to listen to events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				can.cid(<span class="hljs-keyword">this</span>, <span class="hljs-string">".map"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Sets all <code>attrs</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">this</span>._init = <span class="hljs-number">1</span>;
				<span class="hljs-keyword">this</span>._computedBindings = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>It’s handy if we pass this to computes, because computes can have a default value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> defaultValues = <span class="hljs-keyword">this</span>._setupDefaults(obj);
				<span class="hljs-keyword">this</span>._setupComputes(defaultValues);
				<span class="hljs-keyword">var</span> teardownMapping = obj &amp;&amp; can.Map.helpers.addToMap(obj, <span class="hljs-keyword">this</span>);

				<span class="hljs-keyword">var</span> data = can.extend(can.extend(<span class="hljs-literal">true</span>, {}, defaultValues), obj);

				<span class="hljs-keyword">this</span>.attr(data);

				<span class="hljs-keyword">if</span> (teardownMapping) {
					teardownMapping();
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p><code>batchTrigger</code> change events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">this</span>.bind(<span class="hljs-string">'change'</span>, can.proxy(<span class="hljs-keyword">this</span>._changes, <span class="hljs-keyword">this</span>));

				<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._init;
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Sets up computed properties on a Map.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_setupComputes: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				<span class="hljs-keyword">var</span> computes = <span class="hljs-keyword">this</span>.constructor._computes;

				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = computes.length, prop; i &lt; len; i++) {
					prop = computes[i];</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Make the context of the compute the current Map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">this</span>[prop] = <span class="hljs-keyword">this</span>[prop].clone(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Keep track of computed properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">this</span>._computedBindings[prop] = {
						count: <span class="hljs-number">0</span>
					};
				}
			},
			_setupDefaults: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.constructor.defaults || {};
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Setup child bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_bindsetup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{},</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Teardown child bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_bindteardown: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{},</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p><code>change</code>event handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_changes: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ev, attr, how, newVal, oldVal)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>when a change happens, create the named event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				can.batch.trigger(<span class="hljs-keyword">this</span>, {
					type: attr,
					batchNum: ev.batchNum,
					target: ev.target
				}, [newVal, oldVal]);


			},</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Trigger a change event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_triggerChange: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attr, how, newVal, oldVal)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>so this change can bubble … a bubbling change triggers the
_changes trigger</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span>(bubble.isBubbling(<span class="hljs-keyword">this</span>, <span class="hljs-string">"change"</span>)) {
					can.batch.trigger(<span class="hljs-keyword">this</span>, {
						type: <span class="hljs-string">"change"</span>,
						target: <span class="hljs-keyword">this</span>
					}, [attr, how, newVal, oldVal]);
				} <span class="hljs-keyword">else</span> {
					can.batch.trigger(<span class="hljs-keyword">this</span>, attr, [newVal, oldVal]);
				}

				<span class="hljs-keyword">if</span>(how === <span class="hljs-string">"remove"</span> || how === <span class="hljs-string">"add"</span>) {
					can.batch.trigger(<span class="hljs-keyword">this</span>, {
						type: <span class="hljs-string">"__keys"</span>,
						target: <span class="hljs-keyword">this</span>
					});
				}
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Iterator that does not trigger live binding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_each: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> </span>{
				<span class="hljs-keyword">var</span> data = <span class="hljs-keyword">this</span>.__get();
				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> data) {
					<span class="hljs-keyword">if</span> (data.hasOwnProperty(prop)) {
						callback(data[prop], prop);
					}
				}
			},

			attr: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attr, val)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>This is super obfuscated for space — basically, we’re checking
if the type of the attribute is not a <code>number</code> or a <code>string</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> type = <span class="hljs-keyword">typeof</span> attr;
				<span class="hljs-keyword">if</span> (type !== <span class="hljs-string">"string"</span> &amp;&amp; type !== <span class="hljs-string">"number"</span>) {
					<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._attrs(attr, val);</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>If we are getting a value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">1</span>) {
					can.__reading(<span class="hljs-keyword">this</span>, attr);
					<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._get(attr);
				} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Otherwise we are setting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">this</span>._set(attr, val);
					<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
				}
			},

			each: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				<span class="hljs-keyword">return</span> can.each.apply(<span class="hljs-literal">undefined</span>, [<span class="hljs-keyword">this</span>].concat(can.makeArray(<span class="hljs-built_in">arguments</span>)));
			},

			removeAttr: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attr)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>If this is List.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> isList = can.List &amp;&amp; <span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> can.List,</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Convert the <code>attr</code> into parts (if nested).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					parts = can.Map.helpers.attrParts(attr),</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>The actual property to remove.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					prop = parts.shift(),</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>The current value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					current = isList ? <span class="hljs-keyword">this</span>[prop] : <span class="hljs-keyword">this</span>._data[prop];</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>If we have more parts, call <code>removeAttr</code> on that part.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (parts.length &amp;&amp; current) {
					<span class="hljs-keyword">return</span> current.removeAttr(parts);
				} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>If attr does not have a <code>.</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> attr === <span class="hljs-string">'string'</span> &amp;&amp; !!~attr.indexOf(<span class="hljs-string">'.'</span>)) {
						prop = attr;
					}

					<span class="hljs-keyword">this</span>._remove(prop, current);
					<span class="hljs-keyword">return</span> current;
				}
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Remove a property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(prop, current)</span></span>{
				<span class="hljs-keyword">if</span> (prop <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>._data) {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Delete the property from <code>_data</code> and the Map
as long as it isn’t part of the Map’s prototype.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._data[prop];
					<span class="hljs-keyword">if</span> (!(prop <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.constructor.prototype)) {
						<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>[prop];
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Let others now this property has been removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">this</span>._triggerChange(prop, <span class="hljs-string">"remove"</span>, <span class="hljs-literal">undefined</span>, current);

				}
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Reads a property from the <code>object</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attr)</span> </span>{
				attr = <span class="hljs-string">""</span>+attr;
				<span class="hljs-keyword">var</span> dotIndex = attr.indexOf(<span class="hljs-string">'.'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Handles the case of a key having a <code>.</code> in its name
Otherwise we have to dig deeper into the Map to get the value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span>( dotIndex &gt;= <span class="hljs-number">0</span> ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Attempt to get the value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.__get(attr);</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>For keys with a <code>.</code> in them, value will be defined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span>) {
						<span class="hljs-keyword">return</span> value;
					}
					<span class="hljs-keyword">var</span> first = attr.substr(<span class="hljs-number">0</span>, dotIndex),
						second = attr.substr(dotIndex+<span class="hljs-number">1</span>),
						current = <span class="hljs-keyword">this</span>.__get( first );
					<span class="hljs-keyword">return</span> current &amp;&amp; current._get ?  current._get(second) : <span class="hljs-literal">undefined</span>;
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.__get( attr );
				}
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Reads a property directly if an <code>attr</code> is provided, otherwise
returns the “real” data object itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			__get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attr)</span> </span>{
				<span class="hljs-keyword">if</span> (attr) {</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>If property is a compute return the result, otherwise get the value directly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._computedBindings[attr]) {
						<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[attr]();
					} <span class="hljs-keyword">else</span> {
						<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._data[attr];
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>If not property is provided, return entire <code>_data</code> object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._data;
				}
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>converts the value into an observable if needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			__type: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, prop)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>If we are getting an object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (!( value <span class="hljs-keyword">instanceof</span> can.Map) &amp;&amp; can.Map.helpers.canMakeObserve(value)  ) {

					<span class="hljs-keyword">var</span> cached = getMapFromObject(value);
					<span class="hljs-keyword">if</span>(cached) {
						<span class="hljs-keyword">return</span> cached;
					}
					<span class="hljs-keyword">if</span>( can.isArray(value) ) {
						<span class="hljs-keyword">var</span> List = can.List;
						<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> List(value);
					} <span class="hljs-keyword">else</span> {
						<span class="hljs-keyword">var</span> Map = <span class="hljs-keyword">this</span>.constructor.Map || can.Map;
						<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Map(value);
					}
				}
				<span class="hljs-keyword">return</span> value;
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Sets <code>attr</code> prop as value on this object where.
<code>attr</code> - Is a string of properties or an array  of property values.
<code>value</code> - The raw value to set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attr, value, keepKey)</span> </span>{
				attr = <span class="hljs-string">""</span>+attr;
				<span class="hljs-keyword">var</span> dotIndex = attr.indexOf(<span class="hljs-string">'.'</span>),
					current;
				<span class="hljs-keyword">if</span>(!keepKey &amp;&amp; dotIndex &gt;= <span class="hljs-number">0</span>){
					<span class="hljs-keyword">var</span> first = attr.substr(<span class="hljs-number">0</span>, dotIndex),
						second = attr.substr(dotIndex+<span class="hljs-number">1</span>);

					current =  <span class="hljs-keyword">this</span>._init ? <span class="hljs-literal">undefined</span> : <span class="hljs-keyword">this</span>.__get( first );

					<span class="hljs-keyword">if</span>( Map.helpers.isObservable(current) ) {
						current._set(second, value);
					} <span class="hljs-keyword">else</span> {
						<span class="hljs-keyword">throw</span> <span class="hljs-string">"can.Map: Object does not exist"</span>;
					}
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.__convert) {</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Convert if there is a converter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						value = <span class="hljs-keyword">this</span>.__convert(attr, value);
					}
					current = <span class="hljs-keyword">this</span>._init ? <span class="hljs-literal">undefined</span> : <span class="hljs-keyword">this</span>.__get( attr );
					<span class="hljs-keyword">this</span>.__set(attr, <span class="hljs-keyword">this</span>.__type(value, attr), current);
				}
			},
			__set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(prop, value, current)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>TODO: Check if value is object and transform.
Don’t do anything if the value isn’t changing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (value !== current) {</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Check if we are adding this for the first time —
if we are, we need to create an <code>add</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">var</span> changeType = current !== <span class="hljs-literal">undefined</span> || <span class="hljs-keyword">this</span>.__get()
						.hasOwnProperty(prop) ? <span class="hljs-string">"set"</span> : <span class="hljs-string">"add"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Set the value on <code>_data</code> and hook it up to send event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">this</span>.___set(prop, <span class="hljs-keyword">this</span>.constructor._bubble.set(<span class="hljs-keyword">this</span>, prop, value, current) );</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p><code>batchTrigger</code> the change event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">this</span>._triggerChange(prop, changeType, value, current);</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>If we can stop listening to our old value, do it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (current) {
						<span class="hljs-keyword">this</span>.constructor._bubble.teardownFromParent(<span class="hljs-keyword">this</span>, current);
					}
				}

			},</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Directly sets a property on this <code>object</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			___set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(prop, val)</span> </span>{
				<span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._computedBindings[prop] ) {
					<span class="hljs-keyword">this</span>[prop](val);
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">this</span>._data[prop] = val;
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Add property directly for easy writing.
Check if its on the <code>prototype</code> so we don’t overwrite methods like <code>attrs</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.constructor.prototype[prop] !== <span class="hljs-string">'function'</span> &amp;&amp; !<span class="hljs-keyword">this</span>._computedBindings[prop] ) {
					<span class="hljs-keyword">this</span>[prop] = val;
				}
			},

			bind: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventName, handler)</span> </span>{
				<span class="hljs-keyword">var</span> computedBinding = <span class="hljs-keyword">this</span>._computedBindings &amp;&amp; <span class="hljs-keyword">this</span>._computedBindings[eventName];
				<span class="hljs-keyword">if</span> (computedBinding) {</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>The first time we bind to this computed property we
initialize <code>count</code> and <code>batchTrigger</code> the change event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (!computedBinding.count) {
						computedBinding.count = <span class="hljs-number">1</span>;
						<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
						computedBinding.handler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ev, newVal, oldVal)</span> </span>{
							can.batch.trigger(self, {
								type: eventName,
								batchNum: ev.batchNum,
								target: self
							}, [newVal, oldVal]);
						};
						<span class="hljs-keyword">this</span>[eventName].bind(<span class="hljs-string">"change"</span>, computedBinding.handler);
					} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Increment number of things listening to this computed property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						computedBinding.count++;
					}

				}</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>The first time we bind to this Map, <code>_bindsetup</code> will
be called to setup child event bubbling.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">this</span>.constructor._bubble.bind(<span class="hljs-keyword">this</span>, eventName);
				<span class="hljs-keyword">return</span> can.bindAndSetup.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

			},

			unbind: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventName, handler)</span> </span>{
				<span class="hljs-keyword">var</span> computedBinding = <span class="hljs-keyword">this</span>._computedBindings &amp;&amp; <span class="hljs-keyword">this</span>._computedBindings[eventName];
				<span class="hljs-keyword">if</span> (computedBinding) {</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>If there is only one listener, we unbind the change event handler
and clean it up since no one is listening to this property any more.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (computedBinding.count === <span class="hljs-number">1</span>) {
						computedBinding.count = <span class="hljs-number">0</span>;
						<span class="hljs-keyword">this</span>[eventName].unbind(<span class="hljs-string">"change"</span>, computedBinding.handler);
						<span class="hljs-keyword">delete</span> computedBinding.handler;
					} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Decrement number of things listening to this computed property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						computedBinding.count--;
					}

				}
				<span class="hljs-keyword">this</span>.constructor._bubble.unbind(<span class="hljs-keyword">this</span>, eventName);
				<span class="hljs-keyword">return</span> can.unbindAndTeardown.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

			},

			serialize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				<span class="hljs-keyword">return</span> can.Map.helpers.serialize(<span class="hljs-keyword">this</span>, <span class="hljs-string">'serialize'</span>, {});
			},
			<span class="hljs-comment">/**
			 * @hide
			 * Set multiple properties on the observable
			 * @param {Object} props
			 * @param {Boolean} remove true if you should remove properties that are not in props
			 */</span>
			_attrs: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(props, remove)</span> </span>{
				<span class="hljs-keyword">if</span> (props === <span class="hljs-literal">undefined</span>) {
					<span class="hljs-keyword">return</span> Map.helpers.serialize(<span class="hljs-keyword">this</span>, <span class="hljs-string">'attr'</span>, {});
				}

				props = can.simpleExtend({}, props);
				<span class="hljs-keyword">var</span> prop,
					self = <span class="hljs-keyword">this</span>,
					newVal;</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Batch all of the change events until we are done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				can.batch.start();</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Merge current properties with the new ones.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">this</span>.each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(curVal, prop)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>You can not have a _cid property; abort.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (prop === <span class="hljs-string">"_cid"</span>) {
						<span class="hljs-keyword">return</span>;
					}
					newVal = props[prop];</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>If we are merging, remove the property if it has no value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (newVal === <span class="hljs-literal">undefined</span>) {
						<span class="hljs-keyword">if</span> (remove) {
							self.removeAttr(prop);
						}
						<span class="hljs-keyword">return</span>;
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Run converter if there is one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (self.__convert) {
						newVal = self.__convert(prop, newVal);
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>If we’re dealing with models, we want to call _set to let converters run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> ( Map.helpers.isObservable( newVal ) ) {

						self.__set(prop, self.__type(newVal, prop), curVal);</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>If its an object, let attr merge.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Map.helpers.isObservable(curVal) &amp;&amp; Map.helpers.canMakeObserve(newVal) ) {
						curVal.attr(newVal, remove);</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Otherwise just set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (curVal !== newVal) {
						self.__set(prop, self.__type(newVal, prop), curVal);
					}

					<span class="hljs-keyword">delete</span> props[prop];
				});</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Add remaining props.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">for</span> (prop <span class="hljs-keyword">in</span> props) {</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Ignore _cid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (prop !== <span class="hljs-string">"_cid"</span>) {
						newVal = props[prop];
						<span class="hljs-keyword">this</span>._set(prop, newVal, <span class="hljs-literal">true</span>);
					}

				}
				can.batch.stop();
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
			},

			compute: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(prop)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>If the property is a function, use it as the getter/setter
otherwise, create a new compute that returns the value of a property on <code>this</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (can.isFunction(<span class="hljs-keyword">this</span>.constructor.prototype[prop])) {
					<span class="hljs-keyword">return</span> can.compute(<span class="hljs-keyword">this</span>[prop], <span class="hljs-keyword">this</span>);
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">var</span> reads = prop.split(<span class="hljs-string">"."</span>),
						last = reads.length - <span class="hljs-number">1</span>,
						options = {
							args: []
						};
					<span class="hljs-keyword">return</span> can.compute(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newVal)</span> </span>{
						<span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length) {
							can.compute.read(<span class="hljs-keyword">this</span>, reads.slice(<span class="hljs-number">0</span>, last))
								.value.attr(reads[last], newVal);
						} <span class="hljs-keyword">else</span> {
							<span class="hljs-keyword">return</span> can.compute.read(<span class="hljs-keyword">this</span>, reads, options)
								.value;
						}
					}, <span class="hljs-keyword">this</span>);
				}

			}
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Setup on/off aliases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	Map.prototype.on = Map.prototype.bind;
	Map.prototype.off = Map.prototype.unbind;

	<span class="hljs-keyword">return</span> Map;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
